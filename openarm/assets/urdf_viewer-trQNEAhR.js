import{c as V,B as he,f as K}from"./connect-DkGLCYAo.js";import{W as ye,S as ve,A as we,D as te,P as xe,O as be,G as Ee,a as Ie,l as Ce,U as Be,m as Se,V as Y}from"./URDFLoader-CL7UVBjw.js";const $=new URLSearchParams(location.search),Le="https://cdn.1ms.ai",je="anon/xoq-serial",$e="urdf/so101/so101.urdf",z=document.getElementById("urdfUrl"),ne=document.getElementById("relayUrl"),oe=document.getElementById("path"),R=document.getElementById("certHash");z.value=$.get("urdf")||$e;ne.value=$.get("relay")||Le;oe.value=$.get("path")||je;R.value=$.get("certHash")||localStorage.getItem("moq-cert-hash")||"";R.addEventListener("input",()=>localStorage.setItem("moq-cert-hash",R.value));const S=document.getElementById("log"),M=document.getElementById("startBtn"),G=document.getElementById("stopBtn"),g=document.getElementById("queryBtn"),Fe=document.getElementById("loadUrdfBtn"),Te=document.getElementById("statusText");let m=null,h=[];const D={};let F=null,T=null,j=null,v=null,P=!1,_=0,Q=0,H=0,X=performance.now(),x=null,k=!1;function r(e,n="info"){const t=document.createElement("div");t.className=`log-entry log-${n}`,t.textContent=`[${new Date().toLocaleTimeString()}] ${e}`,S.appendChild(t),S.children.length>200&&S.removeChild(S.firstChild),S.scrollTop=S.scrollHeight}function ke(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} K`:`${(e/(1024*1024)).toFixed(1)} M`}function L(e){Te.textContent=e}const Re=2,se=56;function Ue(e){let n=0;for(let t=0;t<e.length;t++)n+=e[t];return~n&255}function ae(e,n,t){const o=new Uint8Array([e,4,Re,n,t]),s=Ue(o),a=new Uint8Array(2+o.length+1);return a[0]=255,a[1]=255,a.set(o,2),a[a.length-1]=s,a}function re(e){return(e-2048)*(Math.PI/2048)}const ce="urdf-viewer-joint-mapping";function Ne(){try{const e=localStorage.getItem(ce);if(e)return JSON.parse(e)}catch{}return ie()}function ie(){return{1:"1",2:"2",3:"3",4:"4",5:"5",6:"6"}}function O(e){localStorage.setItem(ce,JSON.stringify(e))}let d=Ne();const Z=document.getElementById("mappingRows"),Pe=document.getElementById("addMappingBtn"),Ae=document.getElementById("resetMappingBtn");function U(){Z.innerHTML="";for(const[e,n]of Object.entries(d)){const t=document.createElement("div");t.className="mapping-row";const o=document.createElement("input");o.type="text",o.value=e,o.title="Servo ID";const s=document.createElement("span");s.textContent="→",s.style.color="#666";const a=document.createElement("select"),c=document.createElement("option");c.value="",c.textContent="(none)",a.appendChild(c);for(const l of h){const y=document.createElement("option");y.value=l,y.textContent=l,l===n&&(y.selected=!0),a.appendChild(y)}if(h.length===0){const l=document.createElement("option");l.value=n,l.textContent=n,l.selected=!0,a.appendChild(l)}const f=document.createElement("button");f.className="remove-btn",f.textContent="×",f.addEventListener("click",()=>{delete d[e],O(d),U()});const w=()=>{const l=e,y=o.value.trim(),q=a.value;l!==y&&delete d[l],y&&(d[y]=q),O(d)};o.addEventListener("change",w),a.addEventListener("change",w),t.appendChild(o),t.appendChild(s),t.appendChild(a),t.appendChild(f),Z.appendChild(t)}}Pe.addEventListener("click",()=>{let e=1;for(;d[String(e)];)e++;d[String(e)]=h[0]||"",O(d),U()});Ae.addEventListener("click",()=>{d=ie(),O(d),U()});U();function Me(){const e=R.value.trim(),n={};if(e){const t=e.replace(/[^0-9a-fA-F]/g,""),o=new Uint8Array(t.length/2);for(let s=0;s<o.length;s++)o[s]=parseInt(t.substr(s*2,2),16);n.webtransport={serverCertificateHashes:[{algorithm:"sha-256",value:o.buffer}]},r(`Using cert hash: ${t.slice(0,16)}...`,"data")}return n}const J=document.getElementById("threeCanvas");let b;try{b=new ye({canvas:J,antialias:!0,preserveDrawingBuffer:!0}),b.setPixelRatio(window.devicePixelRatio),b.setClearColor(1710638)}catch(e){r(`WebGL not available: ${e.message}`,"error"),b=null}const E=new ve,De=new we(16777215,.6);E.add(De);const le=new te(16777215,.8);le.position.set(5,10,7);E.add(le);const de=new te(4491519,.3);de.position.set(-5,3,-5);E.add(de);const I=new xe(50,1,.01,100);I.position.set(.3,.3,.4);I.lookAt(0,.1,0);const C=new be(I,J);C.target.set(0,.1,0);C.enableDamping=!0;C.dampingFactor=.1;C.update();const ue=new Ee(1,20,3355477,2236996);E.add(ue);const He=new Ie(.1);E.add(He);const ee=document.getElementById("jointRows"),A={};function Oe(){ee.innerHTML="";const e=[16739125,16747586,16755021,16765286,448160,1149618,473932,8599788];h.forEach((n,t)=>{const o=e[t%e.length],s=document.createElement("div");s.className="joint-row",s.innerHTML=`
          <span class="joint-label" style="color:#${o.toString(16).padStart(6,"0")}">${n}</span>
          <span class="joint-angle" id="jangle-${t}">0.0&deg;</span>
          <span class="joint-raw" id="jraw-${t}">-</span>
        `,ee.appendChild(s),A[n]={angleEl:s.querySelector(`#jangle-${t}`),rawEl:s.querySelector(`#jraw-${t}`)}})}function qe(){if(!m)return;const e=new Se().setFromObject(m),n=e.getCenter(new Y),t=e.getSize(new Y),s=Math.max(t.x,t.y,t.z)*1.8;I.position.set(n.x+s*.7,n.y+s*.5,n.z+s*.7),I.lookAt(n),C.target.copy(n),C.update();const a=e.min.y;ue.position.y=a,r(`Loaded: bbox size=(${t.x.toFixed(3)}, ${t.y.toFixed(3)}, ${t.z.toFixed(3)})`,"data")}async function me(e){m&&(E.remove(m),m=null,h=[]),r(`Loading URDF: ${e}...`);const n=new Ce,t=new Be(n);return new Promise((o,s)=>{n.onLoad=()=>{r("All meshes loaded","success"),qe()},t.load(e,a=>{m=a,m.rotation.x=-Math.PI/2,E.add(m),h=[];for(const[c,f]of Object.entries(m.joints))(f.jointType==="revolute"||f.jointType==="continuous")&&h.push(c);h.sort((c,f)=>{const w=parseInt(c),l=parseInt(f);return!isNaN(w)&&!isNaN(l)?w-l:c.localeCompare(f)}),r(`Loaded ${m.robotName}: ${h.length} joints [${h.join(", ")}]`,"success"),Oe(),U(),o(m)},void 0,a=>{r(`URDF load error: ${a}`,"error"),s(a)})})}Fe.addEventListener("click",()=>{const e=z.value.trim();e&&me(e)});me(z.value.trim()).catch(()=>{});function ze(){if(m)for(const[e,n]of Object.entries(d)){if(!n||!D[e]||!m.joints[n])continue;const o=re(D[e].position);m.setJointValue(n,o)}}function Ge(){for(const[n,t]of Object.entries(d)){if(!t||!A[t])continue;const o=D[n];if(!o)continue;const s=(re(o.position)*180/Math.PI).toFixed(1);A[t].angleEl.innerHTML=`${s}&deg;`,A[t].rawEl.textContent=o.position}document.getElementById("frameCount").textContent=_,document.getElementById("bytesReceived").textContent=ke(Q);const e=performance.now();e-X>=1e3&&(document.getElementById("canFps").textContent=H,H=0,X=e),document.getElementById("lastUpdate").textContent=new Date().toLocaleTimeString().split(" ")[0]}function pe(){if(!b)return;const e=J.parentElement,n=e.clientWidth,t=e.clientHeight;b.setSize(n,t),I.aspect=n/t,I.updateProjectionMatrix()}window.addEventListener("resize",pe);requestAnimationFrame(pe);function fe(){requestAnimationFrame(fe),b&&(C.update(),ze(),b.render(E,I))}fe();let i=new Uint8Array(0);function _e(e){const n=new Uint8Array(i.length+e.length);n.set(i),n.set(e,i.length),i=n}function Qe(){for(;i.length>=6;){let e=-1;for(let c=0;c<i.length-1;c++)if(i[c]===255&&i[c+1]===255){e=c;break}if(e<0){i=new Uint8Array(0);return}if(e>0&&(i=i.slice(e)),i.length<4)return;const n=i[3],t=4+n;if(i.length<t)return;const o=i[2],s=i[4],a=i.slice(5,3+n);if(s===0&&a.length>=2){const c=a[0]|a[1]<<8;c>=0&&c<=4095&&(D[String(o)]={position:c,updated:!0},_++,H++)}Q+=t,i=i.slice(t)}}M.addEventListener("click",async()=>{try{const e=ne.value,n=oe.value,t=`${e}/${n}/s2c`,o=`${e}/${n}/c2s`;M.disabled=!0,G.disabled=!1,P=!0,_=0,Q=0,H=0,i=new Uint8Array(0),L("Connecting...");const s=Me();if(!R.value.trim())try{const u=`${e}/certificate.sha256`,p=await fetch(u);if(p.ok){const B=await p.text();r(`Relay cert hash: ${B.trim().slice(0,32)}...`,"data")}}catch(u){r(`Cert hash fetch failed: ${u.message}`,"error")}r(`Publishing commands to ${o}...`);const c=new Promise((u,p)=>setTimeout(()=>p(new Error("c2s connection timeout after 8s")),8e3));T=await Promise.race([V(new URL(o),s),c]),j=new he,T.publish(K(""),j),r("c2s broadcast published, waiting for serial server...","data");const f=new Promise((u,p)=>setTimeout(()=>p(new Error("No subscriber after 15s — is moq-serial-server running on this path?")),15e3)),w=await Promise.race([j.requested(),f]);if(!w)throw new Error("Command broadcast closed");v=w.track,r(`Command track "${v.name}" active`,"success"),r(`Subscribing to ${t}...`);const l=new Promise((u,p)=>setTimeout(()=>p(new Error("s2c connection timeout after 8s")),8e3));F=await Promise.race([V(new URL(t),s),l]);const q=F.consume(K("")).subscribe("data",0);r("Subscribed to s2c 'data' track","success");const N=Object.keys(d).map(Number).filter(u=>!isNaN(u)&&u>0);let W=0;for(x=setInterval(()=>{if(!v||N.length===0)return;const u=N[W%N.length],p=ae(u,se,2),B=v.appendGroup();B.writeFrame(p),B.close(),W++},15),k=!0,g.classList.add("active"),g.textContent="Stop Query",g.disabled=!1,r(`Querying servos [${N.join(",")}] at ~${Math.round(1e3/15)}Hz`,"success"),L("Streaming");P;){const u=await q.nextGroup();if(!u){r("Track ended");break}for(;P;){const p=await u.readFrame();if(!p)break;const B=new Uint8Array(p);_e(B),Qe()}}L("Ended")}catch(e){r(`Error: ${e.message}`,"error"),console.error(e),L("Error")}finally{ge()}});function ge(){if(x&&(clearInterval(x),x=null),k=!1,g.classList.remove("active"),g.textContent="Query Servos",g.disabled=!0,M.disabled=!1,G.disabled=!0,v){try{v.close()}catch{}v=null}if(j){try{j.close()}catch{}j=null}if(T){try{T.close()}catch{}T=null}}G.addEventListener("click",async()=>{if(P=!1,ge(),L("Stopping..."),F){try{F.close()}catch{}F=null}L("Disconnected"),r("Disconnected","success")});g.addEventListener("click",()=>{if(k)x&&(clearInterval(x),x=null),k=!1,g.classList.remove("active"),g.textContent="Query Servos",r("Query paused");else{const e=Object.keys(d).map(Number).filter(t=>!isNaN(t)&&t>0);let n=0;x=setInterval(()=>{if(!v||e.length===0)return;const t=e[n%e.length],o=ae(t,se,2),s=v.appendGroup();s.writeFrame(o),s.close(),n++},15),k=!0,g.classList.add("active"),g.textContent="Stop Query",r("Query resumed","success")}});setInterval(Ge,100);r("Ready. Load a URDF and connect to start.","info");($.has("relay")||$.has("path"))&&(r("Auto-connecting from query params...","info"),M.click());
