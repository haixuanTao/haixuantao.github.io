var y=Object.defineProperty;var k=(a,t,e)=>t in a?y(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>k(a,typeof t!="symbol"?t+"":t,e);import{c as E,B as v,f as T}from"./connect-DkGLCYAo.js";class B{constructor(t){r(this,"config");r(this,"connection",null);r(this,"broadcast",null);r(this,"abortController",null);r(this,"running",!1);r(this,"activeTrack",null);this.config={trackName:"serial",groupSize:1024,...t}}async start(){if(this.running)throw new Error("Publisher is already running");this.running=!0,this.abortController=new AbortController;const{serial:t,url:e,path:l,trackName:i,groupSize:n}=this.config;this.connection=await E(new URL(e)),this.broadcast=new v,this.connection.publish(T(l),this.broadcast),this.handleRequests(i),await this.readSerial(t,i,n)}async handleRequests(t){if(this.broadcast)try{for(;;){const e=await this.broadcast.requested();if(!e||!this.running)break;e.track.name===t?this.publishToTrack(e.track):e.track.close(new Error("track not found"))}}catch{}}publishToTrack(t){this.activeTrack=t}async readSerial(t,e,l){var f,m,p;const i=(f=t.readable)==null?void 0:f.getReader();if(!i)throw new Error("Serial port is not readable");let n=null,h=0;try{for(;this.running;){const{value:b,done:w}=await i.read();if(w||(m=this.abortController)!=null&&m.signal.aborted)break;b&&this.activeTrack&&((!n||h>=l)&&(n==null||n.close(),n=this.activeTrack.appendGroup(),h=0),n.writeFrame(b),h+=b.byteLength)}n==null||n.close(),(p=this.activeTrack)==null||p.close()}finally{i.releaseLock()}}async stop(){var t,e,l;this.running=!1,(t=this.abortController)==null||t.abort(),this.abortController=null,(e=this.broadcast)==null||e.close(),this.broadcast=null,await((l=this.connection)==null?void 0:l.close()),this.connection=null}}const g=document.getElementById("log"),d=document.getElementById("start"),u=document.getElementById("stop");let c=null,s=null;function o(a,t=!1){const e=document.createElement("div");e.textContent=`[${new Date().toLocaleTimeString()}] ${a}`,t&&(e.className="error"),g.appendChild(e),g.scrollTop=g.scrollHeight}d.addEventListener("click",async()=>{try{const a=document.getElementById("url").value,t=document.getElementById("path").value,e=parseInt(document.getElementById("baudRate").value);o("Requesting serial port..."),s=await navigator.serial.requestPort(),await s.open({baudRate:e}),o(`Opened serial port at ${e} baud`),c=new B({url:a,path:t,serial:s}),d.disabled=!0,u.disabled=!1,o(`Connecting to ${a}/${t}...`),await c.start(),o("Publisher stopped")}catch(a){o(`Error: ${a.message}`,!0)}finally{d.disabled=!1,u.disabled=!0}});u.addEventListener("click",async()=>{o("Stopping..."),await(c==null?void 0:c.stop()),await(s==null?void 0:s.close()),c=null,s=null,d.disabled=!1,u.disabled=!0});
