import{c as W,B as st,f as A}from"./connect-DkGLCYAo.js";import{W as _t,S as qt,A as Ot,D as ot,P as Jt,O as Yt,G as Ht,a as zt,B as Ee,b as j,c as at,d as rt,e as ct,M as $e,f as it,g as lt,U as Gt,h as Nt,i as Wt,C as jt,L as Vt,j as Xt,k as ue}from"./URDFLoader-CL7UVBjw.js";const D=new URLSearchParams(location.search),E="openarm.",F=(e,t)=>D.has(e)?D.get(e)||"":localStorage.getItem(E+e)||t,S=document.getElementById("relayUrl"),de=document.getElementById("leftPath"),fe=document.getElementById("rightPath"),me=document.getElementById("depthPath"),he=document.getElementById("depth2Path"),ge=document.getElementById("certHash");S.value=F("relay","https://cdn.1ms.ai");de.value=D.has("left")?D.get("left")||"":D.get("path")||localStorage.getItem(E+"left")||"anon/xoq-can-can0/state";fe.value=F("right","anon/xoq-can-can1/state");me.value=F("depth","anon/realsense");he.value=F("depth2","");ge.value=F("certHash","");const Pe=document.getElementById("chatPath"),Be=document.getElementById("audioPath"),ne=document.getElementById("chatUsername");Pe.value=F("chatPath","anon/openarm-chat");Be.value=F("audioPath","anon/openarm-audio");localStorage.getItem(E+"chatUsername")||localStorage.setItem(E+"chatUsername","anon");ne.value=localStorage.getItem(E+"chatUsername")||"";ne.addEventListener("input",()=>localStorage.setItem(E+"chatUsername",ne.value));const Qt={relay:S,left:de,right:fe,depth:me,depth2:he,certHash:ge,camX:document.getElementById("camX"),camY:document.getElementById("camY"),camZ:document.getElementById("camZ"),camRoll:document.getElementById("camRoll"),camPitch:document.getElementById("camPitch"),camYaw:document.getElementById("camYaw"),cam2X:document.getElementById("cam2X"),cam2Y:document.getElementById("cam2Y"),cam2Z:document.getElementById("cam2Z"),cam2Roll:document.getElementById("cam2Roll"),cam2Pitch:document.getElementById("cam2Pitch"),cam2Yaw:document.getElementById("cam2Yaw"),queryRate:document.getElementById("queryRate"),ptSize:document.getElementById("ptSize"),chatPath:Pe,audioPath:Be};for(const[e,t]of Object.entries(Qt)){const n=localStorage.getItem(E+e);n&&!D.has(e)&&(t.value=n),t.addEventListener("input",()=>localStorage.setItem(E+e,t.value))}const M=document.getElementById("log"),N=document.getElementById("startBtn"),se=document.getElementById("stopBtn"),y=document.getElementById("queryBtn"),C=document.getElementById("audioBtn"),Zt=document.getElementById("statusText"),oe=[{name:"J1",desc:"Shoulder pan",canId:17,color:16739125},{name:"J2",desc:"Shoulder lift",canId:18,color:16747586},{name:"J3",desc:"Shoulder rot",canId:19,color:16755021},{name:"J4",desc:"Elbow flex",canId:20,color:16765286},{name:"J5",desc:"Wrist roll",canId:21,color:448160},{name:"J6",desc:"Wrist pitch",canId:22,color:1149618},{name:"J7",desc:"Wrist rot",canId:23,color:473932},{name:"Grip",desc:"Gripper",canId:24,color:8599788}],Oe=["L_J1","L_J2","L_J3","L_J4","L_J5","L_J6","L_J7"],Je=["R_J1","R_J2","R_J3","R_J4","R_J5","R_J6","R_J7"];function ut(){return new Array(8).fill(null).map(()=>({angle:0,velocity:0,torque:0,tempMos:0,tempRotor:0,updated:!1}))}const ae=ut(),re=ut();let ce=[],$=!1,Le=0,ke=0,ie=0,Ye=performance.now();const U={left:{conn:null,broadcast:null,track:null,group:null},right:{conn:null,broadcast:null,track:null,group:null}};let te=null,R=!1,G=0,xe=0;const f={conn:null,audioCtx:null,nextPlayTime:0,running:!1,enabled:localStorage.getItem(E+"audioEnabled")==="true",framesReceived:0},_=document.getElementById("toasts"),He=4e3,dt=5;function a(e,t="info",{toast:n=!0}={}){const s=document.createElement("div");if(s.className=`log-entry log-${t}`,s.textContent=`[${new Date().toLocaleTimeString()}] ${e}`,M.appendChild(s),M.children.length>200&&M.removeChild(M.firstChild),M.scrollTop=M.scrollHeight,!n)return;const o=document.createElement("div");for(o.className=`toast toast-${t}`,o.style.setProperty("--toast-duration",`${He}ms`),o.textContent=e,_.prepend(o);_.children.length>dt;)_.lastChild.remove();setTimeout(()=>o.remove(),He+400)}function Kt(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} K`:`${(e/(1024*1024)).toFixed(1)} M`}function P(e){Zt.textContent=e}function ft(e,t){const n=document.getElementById(e),s=[];for(let o=0;o<oe.length;o++){const r=oe[o],c=document.createElement("div");c.className="joint-row",c.innerHTML=`
          <span class="joint-label" style="color:#${r.color.toString(16).padStart(6,"0")}">${r.name}</span>
          <span class="joint-angle" id="${t}-angle-${o}">0.0&deg;</span>
          <span class="joint-vel" id="${t}-vel-${o}">0.0</span>
          <span class="joint-tau" id="${t}-tau-${o}">0.0</span>
        `,n.appendChild(c),s.push({angle:c.querySelector(`#${t}-angle-${o}`),vel:c.querySelector(`#${t}-vel-${o}`),tau:c.querySelector(`#${t}-tau-${o}`)})}return s}const en=ft("leftJointRows","l"),tn=ft("rightJointRows","r");function nn(e){const t=[];let n=0;for(;n+6<=e.length;){const s=e.subarray(n),o=s[5];if(n+6+o>e.length)break;const r=new DataView(e.buffer,e.byteOffset+n,6+o);t.push({flags:s[0],canId:r.getUint32(1,!0),dataLen:o,data:e.slice(n+6,n+6+o)}),n+=6+o}return t}function sn(e){if(e.length<8)return null;const t=e[1]<<8|e[2],n=e[3]<<4|e[4]>>4,s=(e[4]&15)<<8|e[5],o=12.5,r=t/65535*(2*o)-o,c=45,i=n/4095*(2*c)-c,d=18,u=s/4095*(2*d)-d,m=e[6],g=e[7];return{qRad:r,vel:i,tau:u,tempMos:m,tempRotor:g}}function V(){const e=ge.value.trim(),t={};if(e){const n=e.replace(/[^0-9a-fA-F]/g,""),s=new Uint8Array(n.length/2);for(let o=0;o<s.length;o++)s[o]=parseInt(n.substr(o*2,2),16);t.webtransport={serverCertificateHashes:[{algorithm:"sha-256",value:s.buffer}]},a(`Using cert hash: ${n.slice(0,16)}...`,"data",{toast:!1})}return t}function mt(e){const t=new Uint8Array(e),n=s=>s.toString(16).padStart(2,"0").toUpperCase();for(let s=0;s<t.length-11;s++){if(t[s+4]===97&&t[s+5]===118&&t[s+6]===99&&t[s+7]===67){const o=s+8;if(o+4<=t.length)return`avc1.${n(t[o+1])}${n(t[o+2])}${n(t[o+3])}`}if(t[s+4]===97&&t[s+5]===118&&t[s+6]===49&&t[s+7]===67){const o=s+8;if(o+4<=t.length){const r=t[o+1]>>5&7,c=t[o+1]&31,i=t[o+2]>>7&1,d=t[o+2]>>6&1,u=t[o+2]>>5&1,m=d?u?12:10:8,g=String(c).padStart(2,"0");return`av01.${r}.${g}${i?"H":"M"}.${String(m).padStart(2,"0")}`}}}return null}function ht(e){return e.length>=8&&e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112}function gt(e,t){const n=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)];let s=0;for(;s<e.length-8;){const o=e[s]<<24|e[s+1]<<16|e[s+2]<<8|e[s+3];if(e[s+4]===n[0]&&e[s+5]===n[1]&&e[s+6]===n[2]&&e[s+7]===n[3])return s;if(o<8)break;s+=o}return-1}function on(e){const t=gt(e,"mdat");if(t<0)return null;const n=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return e.subarray(t+8,t+n)}function an(e){for(let t=0;t<e.length-11;t++)if(e[t+4]===97&&e[t+5]===118&&e[t+6]===49&&e[t+7]===67){const n=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return e.slice(t+8,t+n)}return null}class rn{constructor(){this.decoder=null,this.configured=!1,this.configuredCodec=null,this.latestY=null,this.is10bit=!1,this.width=0,this.height=0,this.frameCount=0,this.copyBuf=null}onData(t){const n=new Uint8Array(t);if(ht(n)){if(!this.configured){const r=an(n),c=mt(n);r&&c&&this.configure(c,r)}const o=gt(n,"moof");o>=0&&this.decodeSample(n.subarray(o),!0)}else this.configured&&this.decodeSample(n,!1)}configure(t,n){if(this.configuredCodec===t)return;if(this.decoder)try{this.decoder.close()}catch{}this.decoder=new VideoDecoder({output:o=>this.processFrame(o).catch(r=>console.error("Depth frame error:",r)),error:o=>console.error("Depth decoder error:",o)});const s=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);this.decoder.configure({codec:t,description:s,hardwareAcceleration:"prefer-software"}),this.configured=!0,this.configuredCodec=t,a(`Depth WebCodecs: ${t}`,"data",{toast:!1})}decodeSample(t,n){const s=on(t);if(!s)return;const o=this.frameCount*(1e6/30);this.decoder.decode(new EncodedVideoChunk({type:n?"key":"delta",timestamp:o,data:s})),this.frameCount++}async processFrame(t){try{const n=t.displayWidth,s=t.displayHeight,o=n*s,r=t.format;this.fmtLogged||(a(`Depth frame format: ${r}, ${n}x${s}`,"data",{toast:!1}),this.fmtLogged=!0);let c=!1;if(r){c=r.includes("10");const i=t.allocationSize();(!this.copyBuf||this.copyBuf.byteLength<i)&&(this.copyBuf=new ArrayBuffer(i));const d=await t.copyTo(this.copyBuf),u=d[0].offset,m=d[0].stride;if(c){(!this.latestY||this.latestY.length!==o)&&(this.latestY=new Uint16Array(o));const g=m/2,h=new Uint16Array(this.copyBuf);if(g===n)this.latestY.set(new Uint16Array(this.copyBuf,u,o));else for(let p=0;p<s;p++)this.latestY.set(h.subarray(u/2+p*g,u/2+p*g+n),p*n)}else{(!this.latestY||this.latestY.length!==o)&&(this.latestY=new Uint8Array(o));const g=new Uint8Array(this.copyBuf);if(m===n)this.latestY.set(new Uint8Array(this.copyBuf,u,o));else for(let h=0;h<s;h++)this.latestY.set(g.subarray(u+h*m,u+h*m+n),h*n)}}else{(!this.offCanvas||this.offCanvas.width!==n||this.offCanvas.height!==s)&&(this.offCanvas=new OffscreenCanvas(n,s),this.offCtx=this.offCanvas.getContext("2d",{willReadFrequently:!0})),this.offCtx.drawImage(t,0,0);const i=this.offCtx.getImageData(0,0,n,s).data;(!this.latestY||this.latestY.length!==o)&&(this.latestY=new Uint8Array(o));for(let d=0;d<o;d++)this.latestY[d]=i[d*4];c=!1,this.canvasFallbackLogged||(a("Depth: GPU frame, using canvas fallback (8-bit)","info",{toast:!1}),this.canvasFallbackLogged=!0)}this.is10bit=c,this.width=n,this.height=s}finally{t.close()}}destroy(){if(this.decoder)try{this.decoder.close()}catch{}this.decoder=null,this.configured=!1,this.latestY=null}}class cn{constructor(t,n){this.video=t,this.label=n,this.ms=null,this.sb=null,this.queue=[],this.ready=!1,this.frames=0,this.seekIv=null}onData(t){if(this.frames++,!this.ready){if(!ht(t))return;const n=mt(t);if(!n){a(`${this.label}: cannot detect codec`,"error");return}this.initMse(n,t);return}this.enqueue(t)}initMse(t,n){const s=`video/mp4; codecs="${t}"`;if(a(`${this.label}: ${s}`,"data"),!MediaSource.isTypeSupported(s)){a(`${this.label}: unsupported`,"error");return}this.ms=new MediaSource,this.video.src=URL.createObjectURL(this.ms),this.ms.addEventListener("sourceopen",()=>{try{this.sb=this.ms.addSourceBuffer(s),this.sb.mode="segments",this.sb.addEventListener("updateend",()=>this.flush()),this.ready=!0,this.enqueue(n),this.video.play().catch(()=>{}),this.seekIv=setInterval(()=>{if(this.video.buffered.length>0){const o=this.video.buffered.start(0),r=this.video.buffered.end(this.video.buffered.length-1);if((this.video.currentTime<o||r-this.video.currentTime>.5)&&(this.video.currentTime=Math.max(o,r-.05)),r-o>10&&!this.sb.updating)try{this.sb.remove(o,r-5)}catch{}}},500)}catch(o){a(`${this.label}: init failed: ${o.message}`,"error")}})}enqueue(t){this.queue.push(t),this.flush()}flush(){if(!(!this.sb||this.sb.updating||!this.queue.length))try{this.sb.appendBuffer(this.queue.shift())}catch(t){a(`${this.label}: ${t.message}`,"error")}}destroy(){if(this.seekIv&&clearInterval(this.seekIv),this.queue=[],this.ready=!1,this.ms&&this.ms.readyState==="open")try{this.ms.endOfStream()}catch{}this.video.src=""}}const Se={conn:null,colorPlayer:null,depthDecoder:null,running:!1},Re={conn:null,colorPlayer:null,depthDecoder:null,running:!1};function q(e,t){return Promise.race([e,new Promise((n,s)=>setTimeout(()=>s(new Error("stale (no data for "+t/1e3+"s)")),t))])}const O=1e4,J=3e3;async function ln(e,t,n,s){const r=`${S.value.trim()}/${t}`;e.colorPlayer=new cn(document.getElementById(n),s+" Color"),e.depthDecoder=new rn;const c=V();a(`[${s}] Connecting to ${r}...`,"info",{toast:!1}),e.conn=await W(new URL(r),c),a(`[${s}] Connected`,"success");const i=e.conn.consume(A("")),d=i.subscribe("video",0),u=i.subscribe("depth",0);a(`[${s}] Subscribed to video + depth tracks`,"success",{toast:!1});async function m(p,b,w){for(;e.running;){const x=await q(p.nextGroup(),O);if(!x){a(`[${s}] ${w} track ended`);break}for(;e.running;){const K=await q(x.readFrame(),O);if(!K)break;b(new Uint8Array(K))}}}const g=m(d,p=>e.colorPlayer.onData(p),"video"),h=m(u,p=>e.depthDecoder.onData(p),"depth");a(`[${s}] Receiving frames...`,"success",{toast:!1}),await Promise.all([g,h])}function pt(e){if(e.conn){try{e.conn.close()}catch{}e.conn=null}e.colorPlayer&&(e.colorPlayer.destroy(),e.colorPlayer=null),e.depthDecoder&&(e.depthDecoder.destroy(),e.depthDecoder=null)}async function ze(e,t,n,s){if(t)for(e.running=!0;e.running;){try{if(await ln(e,t,n,s),!e.running)break;a(`[${s}] Stream ended`,"info")}catch(o){if(!e.running)break;a(`[${s}] ${o.message}`,"error")}if(pt(e),!e.running)break;a(`[${s}] Reconnecting in ${J/1e3}s...`,"info"),await new Promise(o=>setTimeout(o,J))}}async function un(){const e=[],t=me.value.trim(),n=he.value.trim();t&&e.push(ze(Se,t,"colorVideo","cam1")),n&&e.push(ze(Re,n,"colorVideo2","cam2")),e.length&&await Promise.all(e)}function yt(){for(const e of[Se,Re])e.running=!1,pt(e);H.setDrawRange(0,0),z.setDrawRange(0,0)}function dn(){return new Uint8Array([128,0,128,0,0,0,8,0])}function fn(e,t){const n=new Uint8Array(6+t.length);return n[0]=0,n[1]=e&255,n[2]=e>>8&255,n[3]=e>>16&255,n[4]=e>>24&255,n[5]=t.length,n.set(t,6),n}async function Ge(e,t){const n=S.value,s=t.replace(/\/state$/,""),o=`${n}/${s}/commands`,r=U[e];a(`[${e}] Connecting commands to ${o}...`,"info",{toast:!1});const c=V();r.conn=await Promise.race([W(new URL(o),c),new Promise((d,u)=>setTimeout(()=>u(new Error(`[${e}] Command connection timeout`)),8e3))]),r.broadcast=new st,r.conn.publish(A(""),r.broadcast),a(`[${e}] Waiting for CAN server to subscribe (10s)...`);const i=await Promise.race([r.broadcast.requested(),new Promise((d,u)=>setTimeout(()=>u(new Error(`[${e}] No subscriber after 10s — is moq-can-server running?`)),1e4))]);if(!i){a(`[${e}] Command broadcast closed`,"error");return}r.track=i.track,a(`[${e}] Command track active`,"success")}async function mn(){const e=de.value.trim(),t=fe.value.trim(),n=[];e&&n.push(Ge("left",e)),t&&n.push(Ge("right",t)),await Promise.all(n);const s=dn();G=0,xe=0;const o=[];if(U.left.track&&o.push(U.left),U.right.track&&o.push(U.right),o.length===0){a("No command tracks connected","error");return}const r=parseInt(document.getElementById("queryRate").value)||200,c=Math.max(1,Math.round(1e3/r));te=setInterval(()=>{const i=o[xe%o.length];if(!i.track)return;const d=G+1,u=fn(d,s);i.group=i.track.appendGroup(),i.group.writeFrame(u),i.group.close(),G=(G+1)%8,G===0&&xe++},c),a(`Query loop started at ${r}Hz (${o.length} arm${o.length>1?"s":""})`,"success")}function Ae(){te&&(clearInterval(te),te=null);for(const e of["left","right"]){const t=U[e];if(t.group=null,t.track){try{t.track.close()}catch{}t.track=null}if(t.broadcast){try{t.broadcast.close()}catch{}t.broadcast=null}if(t.conn){try{t.conn.close()}catch{}t.conn=null}}a("Query loop stopped")}const l={conn:null,broadcast:null,track:null,announced:null,subscribers:new Map,running:!1},hn=Math.random().toString(36).slice(2,8);function Fe(){return ne.value.trim()||"Anon"}function wt(){return`${Fe()}_${hn}`}const Ne=6e4;function bt(e){const t=document.createElement("div");for(t.className="toast toast-chat",t.style.setProperty("--toast-duration",`${Ne}ms`),t.textContent=`${e.name}: ${e.text}`,_.prepend(t);_.children.length>dt;)_.lastChild.remove();setTimeout(()=>t.remove(),Ne+400)}function gn(e){if(!e.trim())return;const t={name:Fe(),text:e.trim(),ts:Date.now()};if(l.track)try{l.track.writeJson(t)}catch(n){a(`[chat] Send error: ${n.message}`,"error")}bt(t)}async function pn(){try{for(;l.running&&l.broadcast;){const e=await l.broadcast.requested();if(!e)break;e.track.name==="messages"?(l.track=e.track,a("[chat] Publish track active","success",{toast:!1})):e.track.close(new Error("unknown track"))}}catch(e){l.running&&a(`[chat] Publish error: ${e.message}`,"error")}}async function yn(e){try{const t=l.conn.consume(A(e)),n=t.subscribe("messages",0);for(l.subscribers.set(e,{broadcast:t,track:n}),a(`[chat] Subscribed to ${e}`,"data",{toast:!1});l.running;){const s=await n.readJson();if(!s)break;bt(s)}}catch(t){l.running&&a(`[chat] ${e}: ${t.message}`,"error")}finally{l.subscribers.delete(e)}}function le(){const e=l.subscribers.size+(l.running?1:0);document.getElementById("viewerCount").textContent=e===1?"1 viewer":`${e} viewers`}async function wn(){try{for(l.announced=l.conn.announced();l.running;){const e=await l.announced.next();if(!e)break;const t=e.path;t!==A(wt())&&(e.active&&!l.subscribers.has(t)?(a(`[chat] User joined: ${String(t).replace(/_[a-z0-9]+$/,"")}`,"data"),yn(t),le()):e.active||(l.subscribers.delete(t),a(`[chat] User left: ${String(t).replace(/_[a-z0-9]+$/,"")}`,"info"),le()))}}catch(e){l.running&&a(`[chat] Discovery error: ${e.message}`,"error")}}async function bn(){const e=S.value.trim(),t=Pe.value.trim();if(!t)return;l.running=!0;const n=`${e}/${t}`,s=V();try{l.conn=await W(new URL(n),s),a("[chat] Connected","success"),l.broadcast=new st,l.conn.publish(A(wt()),l.broadcast),a(`[chat] Publishing as "${Fe()}"`,"data",{toast:!1}),le(),pn(),wn()}catch(o){a(`[chat] ${o.message}`,"error")}}function vt(){l.running=!1;for(const[,e]of l.subscribers)try{e.broadcast.close()}catch{}if(l.subscribers.clear(),l.announced){try{l.announced.close()}catch{}l.announced=null}if(l.track){try{l.track.close()}catch{}l.track=null}if(l.broadcast){try{l.broadcast.close()}catch{}l.broadcast=null}if(l.conn){try{l.conn.close()}catch{}l.conn=null}le()}document.getElementById("chatInput").addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),gn(e.target.value),e.target.value="")});function vn(e){if(e.byteLength<20)return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{sampleRate:t.getUint32(0,!0),channels:t.getUint16(4,!0),sampleFormat:t.getUint16(6,!0),frameCount:t.getUint32(8,!0),timestampUs:t.getUint32(12,!0),dataLength:t.getUint32(16,!0)}}function xn(e,t,n,s){const o=n*s;if(t===1)return new Float32Array(e.buffer,e.byteOffset,o);const r=new Int16Array(e.buffer,e.byteOffset,o),c=new Float32Array(o);for(let i=0;i<o;i++)c[i]=r[i]/32768;return c}function Cn(e,t){const n=f.audioCtx;if(!n)return;const s=xn(t,e.sampleFormat,e.frameCount,e.channels),o=n.createBuffer(e.channels,e.frameCount,e.sampleRate);if(e.channels===1)o.copyToChannel(s,0);else for(let c=0;c<e.channels;c++){const i=new Float32Array(e.frameCount);for(let d=0;d<e.frameCount;d++)i[d]=s[d*e.channels+c];o.copyToChannel(i,c)}const r=n.createBufferSource();r.buffer=o,r.connect(n.destination),f.nextPlayTime<n.currentTime&&(f.nextPlayTime=n.currentTime),r.start(f.nextPlayTime),f.nextPlayTime+=o.duration}async function In(){const e=S.value.trim(),t=Be.value.trim();if(!t)return;const n=`${e}/${t}`,s=V();a(`[audio] Connecting to ${n}...`,"info",{toast:!1}),f.conn=await W(new URL(n),s),a("[audio] Connected","success");const r=f.conn.consume(A("")).subscribe("mic",0);for(a('[audio] Subscribed to "mic" track',"success",{toast:!1});f.running;){const c=await q(r.nextGroup(),O);if(!c){a("[audio] Track ended");break}for(;f.running;){const i=await q(c.readFrame(),O);if(!i)break;const d=new Uint8Array(i),u=vn(d);if(!u||d.byteLength<20+u.dataLength)continue;f.audioCtx||(f.audioCtx=new AudioContext({sampleRate:u.sampleRate}),f.audioCtx.state==="suspended"&&f.audioCtx.resume(),f.nextPlayTime=0,a(`[audio] AudioContext created: ${u.sampleRate}Hz, ${u.channels}ch`,"data",{toast:!1}));const m=d.subarray(20,20+u.dataLength);Cn(u,m),f.framesReceived++}}}async function xt(){for(f.running=!0;f.running;){try{if(await In(),!f.running)break;a("[audio] Stream ended","info")}catch(e){if(!f.running)break;a(`[audio] ${e.message}`,"error")}if(Ct(),!f.running)break;a(`[audio] Reconnecting in ${J/1e3}s...`,"info"),await new Promise(e=>setTimeout(e,J))}}function Ct(){if(f.conn){try{f.conn.close()}catch{}f.conn=null}}function Te(){if(f.running=!1,Ct(),f.audioCtx){try{f.audioCtx.close()}catch{}f.audioCtx=null}f.nextPlayTime=0,f.framesReceived=0}f.enabled&&(C.classList.add("active"),C.innerHTML="&#128266; Audio");C.addEventListener("click",()=>{f.enabled=!f.enabled,localStorage.setItem(E+"audioEnabled",f.enabled),f.enabled?(C.classList.add("active"),C.innerHTML="&#128266; Audio",$&&xt().catch(e=>a(`[audio] ${e.message}`,"error"))):(C.classList.remove("active"),C.innerHTML="&#128263; Audio",Te())});const Me=document.getElementById("threeCanvas");let L;try{L=new _t({canvas:Me,antialias:!0}),L.setPixelRatio(window.devicePixelRatio),L.setClearColor(1710638)}catch(e){a(`WebGL not available: ${e.message} (3D disabled, MoQ still works)`,"error"),L=null}const B=new qt,En=new Ot(16777215,.4);B.add(En);const It=new ot(16777215,.8);It.position.set(5,10,7);B.add(It);const Et=new ot(4491519,.3);Et.position.set(-5,3,-5);B.add(Et);const Y=new Jt(50,1,.01,100);Y.position.set(1,.8,1.2);Y.lookAt(0,.4,0);const X=new Yt(Y,Me);X.target.set(0,.4,0);X.enableDamping=!0;X.dampingFactor=.1;X.update();const $n=new Ht(2,20,3355477,2236996);B.add($n);const Pn=new zt(.1);B.add(Pn);const I=640,k=480,pe=I*k,$t=new Float32Array(pe*3),Pt=new Float32Array(pe*3),H=new Ee;H.setAttribute("position",new j($t,3));H.setAttribute("color",new j(Pt,3));H.setDrawRange(0,0);const ye=new at({size:.002,vertexColors:!0,sizeAttenuation:!0}),Bt=new rt(H,ye);Bt.scale.set(.001,.001,.001);const Lt=new Float32Array(pe*3),kt=new Float32Array(pe*3),z=new Ee;z.setAttribute("position",new j(Lt,3));z.setAttribute("color",new j(kt,3));z.setDrawRange(0,0);const Ue=new at({size:.002,vertexColors:!0,sizeAttenuation:!0}),St=new rt(z,Ue);St.scale.set(.001,.001,.001);const Q=new ct;B.add(Q);Q.add(Bt);const Z=new ct;B.add(Z);Z.add(St);const Bn=new $e(new it(.012,12,8),new lt({color:16720418}));Q.add(Bn);const Ln=new $e(new it(.012,12,8),new lt({color:2237183}));Z.add(Ln);function Rt(e){const r=1.0230000000000001,c=.3*(I/2)/604.2,i=.3*(k/2)/603.5,d=r*(I/2)/604.2,u=r*(k/2)/603.5,m=new Float32Array([-c,i,.3,c,i,.3,c,-i,.3,-c,-i,.3,-d,u,r,d,u,r,d,-u,r,-d,-u,r]),g=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],h=new Ee;return h.setAttribute("position",new j(m,3)),h.setIndex(g),new Vt(h,new Xt({color:e,opacity:.5,transparent:!0}))}let kn=Rt(16729156);Q.add(kn);let Sn=Rt(4474111);Z.add(Sn);const De=document.createElement("canvas");De.width=I;De.height=k;const Rn=De.getContext("2d",{willReadFrequently:!0}),_e=document.createElement("canvas");_e.width=I;_e.height=k;const An=_e.getContext("2d",{willReadFrequently:!0});function At(e,t,n,s,o,r){if(!e.videoWidth||!t||!t.latestY)return;const c=1,i=604.2,d=603.5,u=322.7,m=252.7,g=0;n.drawImage(e,0,0,I,k);const h=t.latestY,p=n.getImageData(0,0,I,k).data;let b=0;for(let w=0;w<k;w+=c)for(let x=0;x<I;x+=c){const K=w*I+x,we=h[K];if(we<2)continue;const be=t.is10bit?we<<g:we<<4,T=b*3;s[T]=-(x-u)*be/i,s[T+1]=-(w-m)*be/d,s[T+2]=be;const ve=(w*I+x)*4;o[T]=p[ve]/255,o[T+1]=p[ve+1]/255,o[T+2]=p[ve+2]/255,b++}r.attributes.position.needsUpdate=!0,r.attributes.color.needsUpdate=!0,r.setDrawRange(0,b),r.computeBoundingSphere()}function Fn(){At(document.getElementById("colorVideo"),Se.depthDecoder,Rn,$t,Pt,H)}function Tn(){At(document.getElementById("colorVideo2"),Re.depthDecoder,An,Lt,kt,z)}document.getElementById("ptSize").addEventListener("input",e=>{const t=parseFloat(e.target.value)*.001;ye.size=t,Ue.size=t});ye.size=parseFloat(document.getElementById("ptSize").value)*.001;Ue.size=ye.size;const We=new ue,je=new ue,Ve=new ue,Ce=new ue;function Ft(e,t,n,s,o,r,c){const i=parseFloat(document.getElementById(t).value)||0,d=parseFloat(document.getElementById(n).value)||0,u=parseFloat(document.getElementById(s).value)||0,m=(parseFloat(document.getElementById(o).value)||0)*Math.PI/180,g=(parseFloat(document.getElementById(r).value)||0)*Math.PI/180,h=(parseFloat(document.getElementById(c).value)||0)*Math.PI/180;e.position.set(i,d,u),We.makeRotationX(m),je.makeRotationY(g),Ve.makeRotationZ(h),Ce.multiplyMatrices(Ve,je),Ce.multiply(We),e.setRotationFromMatrix(Ce)}function Tt(){Ft(Q,"camX","camY","camZ","camRoll","camPitch","camYaw")}function Mt(){Ft(Z,"cam2X","cam2Y","cam2Z","cam2Roll","cam2Pitch","cam2Yaw")}for(const e of["camX","camY","camZ","camRoll","camPitch","camYaw"])document.getElementById(e).addEventListener("input",Tt);for(const e of["cam2X","cam2Y","cam2Z","cam2Roll","cam2Pitch","cam2Yaw"])document.getElementById(e).addEventListener("input",Mt);Tt();Mt();let v=null;const Ut=new Gt;Ut.loadMeshCb=(e,t,n)=>{e.endsWith(".stl")?new Nt(t).load(e,s=>{n(new $e(s,new Wt))},null,s=>n(null,s)):e.endsWith(".dae")?new jt(t).load(e,s=>n(s.scene),null,s=>n(null,s)):n(null,new Error(`Unknown mesh format: ${e}`))};P("Loading 3D model...");a("Loading URDF model...");Ut.load("./assets/openarm_v10.urdf",e=>{v=e,v.rotation.x=-Math.PI/2,B.add(v),P("Idle"),a("3D model loaded","success")},void 0,e=>{a(`URDF load error: ${e}`,"error"),P("Model load failed")});const Mn=-1.0472,Xe=.044;function Qe(e){return Math.max(0,Math.min(Xe,Xe*(e/Mn)))}function Un(){if(!v)return;for(let n=0;n<7;n++)v.joints[Oe[n]]&&v.joints[Oe[n]].setJointValue(ae[n].angle),v.joints[Je[n]]&&v.joints[Je[n]].setJointValue(re[n].angle);const e=Qe(ae[7].angle),t=Qe(re[7].angle);v.joints.L_EE&&v.joints.L_EE.setJointValue(e),v.joints.R_EE&&v.joints.R_EE.setJointValue(t)}function Dn(){function e(n,s){for(let o=0;o<oe.length;o++){const r=s[o],c=(r.angle*180/Math.PI).toFixed(1);n[o].angle.innerHTML=`${c}&deg;`,n[o].vel.textContent=r.velocity.toFixed(1),n[o].tau.textContent=r.torque.toFixed(1)}}e(en,ae),e(tn,re),document.getElementById("frameCount").textContent=Le,document.getElementById("bytesReceived").textContent=Kt(ke);const t=performance.now();t-Ye>=1e3&&(document.getElementById("canFps").textContent=ie,ie=0,Ye=t),document.getElementById("lastUpdate").textContent=new Date().toLocaleTimeString().split(" ")[0]}function qe(){if(!L)return;const e=Me.parentElement,t=e.clientWidth,n=e.clientHeight;L.setSize(t,n),Y.aspect=t/n,Y.updateProjectionMatrix()}window.addEventListener("resize",qe);requestAnimationFrame(qe);const ee=document.getElementById("view3d");function Dt(){requestAnimationFrame(Dt),Un(),L&&(X.update(),Fn(),Tn(),L.render(B,Y))}Dt();async function _n(e,t,n){const o=`${S.value}/${t}`;a(`[${e}] Connecting to ${o}...`,"info",{toast:!1});const r=V(),c=await Promise.race([W(new URL(o),r),new Promise((u,m)=>setTimeout(()=>m(new Error(`[${e}] Connection timeout`)),8e3))]);ce.push(c),a(`[${e}] Connected`,"success");const d=c.consume(A("")).subscribe("can",0);for(a(`[${e}] Subscribed to 'can' track`,"success",{toast:!1});$;){const u=await q(d.nextGroup(),O);if(!u){a(`[${e}] Track ended`);break}for(;$;){const m=await q(u.readFrame(),O);if(!m)break;const g=new Uint8Array(m);ke+=g.length;const h=nn(g);Le+=h.length,ie+=h.length;for(const p of h){const b=oe.findIndex(x=>x.canId===p.canId);if(b<0)continue;const w=sn(p.data);w&&(n[b].angle=w.qRad,n[b].velocity=w.vel,n[b].torque=w.tau,n[b].tempMos=w.tempMos,n[b].tempRotor=w.tempRotor,n[b].updated=!0)}}}}async function Ze(e,t,n){for(;$;){try{if(await _n(e,t,n),!$)break;a(`[${e}] Stream ended`,"info")}catch(s){if(!$)break;a(`[${e}] ${s.message}`,"error")}if(!$)break;a(`[${e}] Reconnecting in ${J/1e3}s...`,"info"),await new Promise(s=>setTimeout(s,J))}}N.addEventListener("click",async()=>{try{const e=de.value.trim(),t=fe.value.trim(),n=me.value.trim(),s=he.value.trim();if(!e&&!t&&!n&&!s){a("No paths configured","error");return}N.disabled=!0,se.disabled=!1,$=!0,Le=0,ke=0,ie=0,ce=[],P("Connecting..."),a(`WebTransport: ${typeof WebTransport<"u"?"supported":"NOT supported"}`,"data",{toast:!1});const o=S.value,r=ge.value.trim();e&&t&&e===t&&a(`WARNING: Left and Right arms use the same path "${e}" — gripper cross-talk expected!`,"error");const c=[];e&&c.push(Ze("left",e,ae).catch(i=>a(`[left] ${i.message}`,"error"))),t&&c.push(Ze("right",t,re).catch(i=>a(`[right] ${i.message}`,"error"))),(n||s)&&c.push(un().catch(i=>a(`[depth] ${i.message}`,"error"))),c.push(bn().catch(i=>a(`[chat] ${i.message}`,"error"))),C.disabled=!1,f.enabled&&c.push(xt().catch(i=>a(`[audio] ${i.message}`,"error"))),y.disabled=!1,P("Streaming"),await Promise.all(c),P("Ended")}catch(e){a(`Error: ${e.message}`,"error"),console.error(e),P("Error")}finally{R&&(Ae(),R=!1,y.classList.remove("active"),y.textContent="Query Motors"),yt(),vt(),Te(),C.disabled=!0,y.disabled=!0,N.disabled=!1,se.disabled=!0}});se.addEventListener("click",async()=>{$=!1,R&&(Ae(),R=!1,y.classList.remove("active"),y.textContent="Query Motors"),y.disabled=!0,P("Stopping..."),yt(),vt(),Te(),C.disabled=!0;for(const e of ce)try{e.close()}catch{}ce=[],N.disabled=!1,se.disabled=!0,P("Disconnected"),a("Disconnected","success")});y.addEventListener("click",async()=>{if(R)Ae(),R=!1,y.classList.remove("active"),y.textContent="Query Motors";else{y.disabled=!0,y.textContent="Starting...";try{await mn(),R=!0,y.classList.add("active"),y.textContent="Stop Query",y.disabled=!1}catch(e){a(`Query start error: ${e.message}`,"error"),console.error(e),y.textContent="Query Motors",y.disabled=!1}}});setInterval(Dn,100);a("Ready. Click Connect to start.","info");a("Auto-connecting in 3s...","info");setTimeout(()=>{a("Connecting now..."),N.click()},3e3);document.getElementById("settingsToggle").addEventListener("click",()=>{document.getElementById("topBarConfig").classList.toggle("open")});const Ke=document.getElementById("tabBar"),et=document.querySelector(".side-panel"),tt=document.getElementById("log"),nt=document.getElementById("cameraSplit"),Ie={arms:[document.getElementById("panelLeft"),document.getElementById("panelRight")],stats:[document.getElementById("panelStats")]},qn=Object.values(Ie).flat();Ke.addEventListener("click",e=>{const t=e.target.closest(".tab-btn");if(!t)return;const n=t.dataset.tab;Ke.querySelectorAll(".tab-btn").forEach(s=>s.classList.remove("active")),t.classList.add("active"),et.classList.remove("tab-visible"),qn.forEach(s=>s.classList.remove("tab-visible")),tt.classList.remove("tab-visible"),nt.classList.remove("tab-visible"),ee.style.display="",n==="3d"?requestAnimationFrame(qe):n==="log"?(tt.classList.add("tab-visible"),ee.style.display="none"):n==="camera"?(nt.classList.add("tab-visible"),ee.style.display="none"):n in Ie&&(et.classList.add("tab-visible"),Ie[n].forEach(s=>s.classList.add("tab-visible")),ee.style.display="none")});
