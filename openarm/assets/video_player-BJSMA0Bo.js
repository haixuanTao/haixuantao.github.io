import{c as x,f as w}from"./connect-DkGLCYAo.js";const o=document.getElementById("video"),b=document.getElementById("log"),p=document.getElementById("startBtn"),y=document.getElementById("stopBtn"),C=document.getElementById("status"),I=document.getElementById("groupCount"),k=document.getElementById("bytesReceived"),R=document.getElementById("bufferLength");let l=null,m=!1,d=null,r=null,g=0,B=0,h=!1,v=[];function t(e,n="info"){const s=document.createElement("div");s.className=`log-entry log-${n}`,s.textContent=`[${new Date().toLocaleTimeString()}] ${e}`,b.appendChild(s),b.scrollTop=b.scrollHeight}function U(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}function $(){if(I.textContent=g,k.textContent=U(B),o.buffered.length>0){const e=o.buffered.end(0)-o.currentTime;R.textContent=`${Math.max(0,e).toFixed(1)}s`}}function i(e){C.textContent=e}function M(){if(v.length>0&&r&&!r.updating){const e=v.shift();try{r.appendBuffer(e)}catch(n){t(`Append error: ${n.message}`,"error")}}}async function T(e){if(!r||r.updating){v.push(e);return}try{r.appendBuffer(e)}catch(n){t(`Append error: ${n.message}`,"error")}}async function A(){return new Promise((e,n)=>{d=new MediaSource,o.src=URL.createObjectURL(d),d.addEventListener("sourceopen",()=>{t("MediaSource opened","success");const s=['video/mp4; codecs="avc1.640028"','video/mp4; codecs="avc1.64001f"','video/mp4; codecs="avc1.4d4028"','video/mp4; codecs="avc1.4d401f"','video/mp4; codecs="avc1.42e01f"','video/mp4; codecs="avc1.640029"'];let f=null;for(const a of s)if(MediaSource.isTypeSupported(a)){f=a;break}if(!f){t("No supported H.264 codec found","error"),n(new Error("No codec supported"));return}t(`Using codec: ${f}`,"success"),r=d.addSourceBuffer(f),r.mode="segments",r.addEventListener("updateend",()=>{M(),$(),o.paused&&o.buffered.length>0&&o.play().catch(()=>{})}),r.addEventListener("error",a=>{t(`SourceBuffer error: ${a.type}`,"error"),console.error("SourceBuffer error:",a)}),e()}),d.addEventListener("error",n)})}p.addEventListener("click",async()=>{try{const e=document.getElementById("relayUrl").value,n=document.getElementById("path").value,s=`${e}/${n}`;p.disabled=!0,y.disabled=!1,m=!0,g=0,B=0,h=!1,v=[],i("Connecting..."),t(`Connecting to ${s}...`),await A(),l=await x(new URL(e)),t("Connected!","success"),i("Subscribing...");const a=l.consume(w(n)).subscribe("video",0);for(t("Subscribed to video track","success"),i("Streaming");m;){const S=await a.nextGroup();if(!S){t("Track ended");break}for(;m;){const u=await S.readFrame();if(!u)break;g++,B+=u.byteLength;const c=new Uint8Array(u),L=Array.from(c.slice(0,8)).map(E=>E.toString(16).padStart(2,"0")).join(" ");if(!h)t(`Init segment: ${u.byteLength} bytes [${L}...]`,"data"),c[4]===102&&c[5]===116&&c[6]===121&&c[7]===112?t("Valid ftyp box detected","success"):t("WARNING: Init segment doesn't start with ftyp!","error"),h=!0;else{t(`Segment ${g-1}: ${u.byteLength} bytes [${L}...]`,"data");const E=String.fromCharCode(c[4],c[5],c[6],c[7]);t(`Box type: ${E}`,"info")}await T(u),$()}}i("Ended")}catch(e){t(`Error: ${e.message}`,"error"),i("Error")}finally{p.disabled=!1,y.disabled=!0}});y.addEventListener("click",async()=>{m=!1,i("Stopping...");try{await(l==null?void 0:l.close())}catch{}if(l=null,(d==null?void 0:d.readyState)==="open")try{d.endOfStream()}catch{}p.disabled=!1,y.disabled=!0,i("Disconnected"),t("Disconnected","success")});o.addEventListener("error",e=>{const n=o.error;t(`Video error: ${(n==null?void 0:n.message)||"unknown"} (code: ${n==null?void 0:n.code})`,"error")});o.addEventListener("loadedmetadata",()=>{t(`Video metadata loaded: ${o.videoWidth}x${o.videoHeight}`,"success")});o.addEventListener("canplay",()=>{t("Video can play!","success")});setInterval($,1e3);t("Ready. Enter relay URL and path, then click Connect.","info");
